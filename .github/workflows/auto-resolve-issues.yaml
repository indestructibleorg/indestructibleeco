name: Auto-Resolve Issues on Fix Merge

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  pull-requests: read

concurrency:
  group: auto-resolve-${{ github.run_id }}
  cancel-in-progress: true

jobs:
  auto-close-issues:
    name: Auto-close Fixed Issues
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
      with:
        fetch-depth: 20

    - name: Parse commit messages for issue references
      id: parse_commits
      env:
        GITHUB_TOKEN: ${{ github.token }}
      run: |
        python3 - << 'PYEOF'
        import subprocess, re, json, os, urllib.request

        token = os.environ.get("GITHUB_TOKEN", "")
        repo = os.environ.get("GITHUB_REPOSITORY", "")

        # Get recent commit messages
        result = subprocess.run(
            ["git", "log", "--oneline", "-20", "--format=%s %b"],
            capture_output=True, text=True
        )
        commits = result.stdout

        # Find issue references: fixes #123, closes #456, resolves #789
        pattern = r'(?:fix(?:es)?|close[sd]?|resolve[sd]?)\s+#(\d+)'
        issue_numbers = set(re.findall(pattern, commits, re.IGNORECASE))

        print(f"Found issue references in recent commits: {issue_numbers}")

        for issue_num in issue_numbers:
            url = f"https://api.github.com/repos/{repo}/issues/{issue_num}"
            req = urllib.request.Request(url, headers={
                "Authorization": f"token {token}",
                "Accept": "application/vnd.github.v3+json",
            })
            try:
                with urllib.request.urlopen(req) as resp:
                    issue = json.loads(resp.read())
                    if issue.get("state") == "open":
                        # Add a comment and close the issue
                        comment_url = f"{url}/comments"
                        comment_data = json.dumps({
                            "body": f"This issue has been automatically closed because a fix was merged to main.\n\nIf this issue is not fully resolved, please reopen it."
                        }).encode()
                        comment_req = urllib.request.Request(
                            comment_url, data=comment_data, method="POST",
                            headers={
                                "Authorization": f"token {token}",
                                "Accept": "application/vnd.github.v3+json",
                                "Content-Type": "application/json",
                            }
                        )
                        with urllib.request.urlopen(comment_req):
                            pass

                        # Close the issue
                        close_data = json.dumps({"state": "closed"}).encode()
                        close_req = urllib.request.Request(
                            url, data=close_data, method="PATCH",
                            headers={
                                "Authorization": f"token {token}",
                                "Accept": "application/vnd.github.v3+json",
                                "Content-Type": "application/json",
                            }
                        )
                        with urllib.request.urlopen(close_req):
                            print(f"Closed issue #{issue_num}")
                    else:
                        print(f"Issue #{issue_num} is already closed")
            except Exception as e:
                print(f"Could not process issue #{issue_num}: {e}")
        PYEOF

  sync-security-alerts:
    name: Sync Security Alerts to Issues
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Check and sync Dependabot alerts
      env:
        GITHUB_TOKEN: ${{ github.token }}
      run: |
        python3 - << 'PYEOF'
        import json, os, urllib.request

        token = os.environ.get("GITHUB_TOKEN", "")
        repo = os.environ.get("GITHUB_REPOSITORY", "")

        # Fetch open Dependabot alerts
        url = f"https://api.github.com/repos/{repo}/dependabot/alerts?state=open&per_page=10"
        req = urllib.request.Request(url, headers={
            "Authorization": f"token {token}",
            "Accept": "application/vnd.github.v3+json",
        })
        try:
            with urllib.request.urlopen(req) as resp:
                alerts = json.loads(resp.read())
                critical = [a for a in alerts if a.get("security_advisory", {}).get("severity") in ["critical", "high"]]
                print(f"Open Dependabot alerts: {len(alerts)} total, {len(critical)} critical/high")
                for alert in critical[:5]:
                    pkg = alert.get("dependency", {}).get("package", {}).get("name", "unknown")
                    severity = alert.get("security_advisory", {}).get("severity", "unknown")
                    print(f"  - {pkg}: {severity}")
        except Exception as e:
            print(f"Could not fetch Dependabot alerts: {e}")
        PYEOF
