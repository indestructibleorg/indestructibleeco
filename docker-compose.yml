# IndestructibleEco v1.0 — Local Development Stack
# URI: indestructibleeco://root/docker-compose
# Usage: docker compose up

version: "3.9"

services:
  # ─── Backend API (Node.js Express) ───
  api:
    build:
      context: ./backend/api
      dockerfile: Dockerfile
    container_name: eco-api
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: development
      PORT: "3000"
      REDIS_URL: redis://redis:6379
      AI_SERVICE_GRPC: ai:8000
      AI_SERVICE_HTTP: http://ai:8001
      SUPABASE_URL: ${SUPABASE_URL:-}
      SUPABASE_KEY: ${SUPABASE_KEY:-}
      JWT_SECRET: ${JWT_SECRET:-dev-secret-change-in-production}
      CONSUL_ENDPOINT: http://consul:8500
      JAEGER_ENDPOINT: http://jaeger:14268/api/traces
    depends_on:
      - redis
      - ai
    restart: unless-stopped

  # ─── Backend AI (Python FastAPI) ───
  ai:
    build:
      context: ./backend/ai
      dockerfile: Dockerfile
    container_name: eco-ai
    ports:
      - "8000:8000"
      - "8001:8001"
    environment:
      HTTP_PORT: "8001"
      GRPC_PORT: "8000"
      REDIS_URL: redis://redis:6379
      CELERY_BROKER: redis://redis:6379/0
      CELERY_BACKEND: redis://redis:6379/1
      VECTOR_DIM: "1024"
      ALIGNMENT_MODEL: quantum-bert-xxl-v1
      AI_MODELS: vllm,ollama,tgi,sglang
      CONSUL_ENDPOINT: http://consul:8500
      JAEGER_ENDPOINT: http://jaeger:14268/api/traces
    depends_on:
      - redis
    restart: unless-stopped

  # ─── Redis ───
  redis:
    image: redis:7-alpine
    container_name: eco-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    restart: unless-stopped

  # ─── PostgreSQL (Supabase local) ───
  postgres:
    image: postgres:16-alpine
    container_name: eco-postgres
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: indestructibleeco
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    restart: unless-stopped

volumes:
  redis-data:
  postgres-data: