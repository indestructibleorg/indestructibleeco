# IndestructibleEco v1.0 — CircleCI Configuration
# URI: indestructibleeco://ci/circleci
# Secondary pipeline — mirrors GitHub Actions validation logic

version: 2.1

jobs:
  runner-test:
    machine: true
    resource_class: indestructibleorg/indestructibleeco
    steps:
      - run: echo "Hi I'm on Runners!"

  validate:
    docker:
      - image: cimg/python:3.11-node
    steps:
      - checkout
      - run:
          name: "CI Validator Engine"
          command: |
            python3 tools/ci-validator/validate.py --report=/tmp/validation-report.json
      - store_artifacts:
          path: /tmp/validation-report.json
          destination: validation-report.json

  lint:
    docker:
      - image: cimg/python:3.11-node
    steps:
      - checkout
      - run:
          name: "Python compile check"
          command: |
            python3 -m py_compile backend/ai/src/app.py
            python3 -m py_compile backend/ai/src/config.py
            python3 -m py_compile backend/ai/src/routes.py
            python3 -m py_compile backend/ai/src/governance.py
            python3 -m py_compile backend/ai/src/routes/health.py
            python3 -m py_compile backend/ai/src/routes/generate.py
            python3 -m py_compile backend/ai/src/routes/models.py
            python3 -m py_compile backend/shared/models/__init__.py
            python3 -m py_compile backend/shared/utils/__init__.py
            python3 -m py_compile tools/ci-validator/validate.py
            python3 -m py_compile tools/skill-creator/scripts/init_skill.py
            python3 -m py_compile tools/skill-creator/scripts/quick_validate.py
            echo "Python compile check passed"
      - run:
          name: "JS syntax check"
          command: |
            node --check tools/yaml-toolkit/bin/cli.js
            node --check tools/skill-creator/scripts/validate.js
            echo "JS syntax check passed"
      - run:
          name: "YAML governance lint"
          command: |
            FAIL=0
            for f in $(find backend/k8s k8s -name "*.qyaml" -type f 2>/dev/null); do
              echo "Checking $f"
              for block in document_metadata governance_info registry_binding vector_alignment_map; do
                if ! grep -q "${block}:" "$f"; then
                  echo "  FAIL: Missing $block in $f"
                  FAIL=1
                fi
              done
              for field in unique_id uri urn target_system schema_version generated_by; do
                if ! grep -q "${field}:" "$f"; then
                  echo "  FAIL: Missing $field in $f"
                  FAIL=1
                fi
              done
            done
            if [ "$FAIL" -eq 1 ]; then exit 1; fi
            echo "All .qyaml files passed governance validation"
      - run:
          name: "Skill manifest validation"
          command: |
            node tools/skill-creator/scripts/validate.js tools/skill-creator/skills
            echo "Skill manifest validation passed"

  test:
    docker:
      - image: cimg/python:3.11-node
    steps:
      - checkout
      - run:
          name: "Config tests"
          command: |
            cat > /tmp/test_config.py << 'PYEOF'
            import sys
            sys.path.insert(0, '.')
            from src.config import Settings
            s = Settings()
            assert s.http_port == 8001
            assert s.grpc_port == 8000
            assert s.vector_dim == 1024
            assert s.alignment_model == 'quantum-bert-xxl-v1'
            print('Config tests passed')
            PYEOF
            cd backend/ai && python3 /tmp/test_config.py
      - run:
          name: "Governance engine tests"
          command: |
            cat > /tmp/test_governance.py << 'PYEOF'
            import sys
            sys.path.insert(0, '.')
            from src.governance import GovernanceEngine
            g = GovernanceEngine()
            engine = g.resolve_engine('vllm-default')
            assert engine == 'vllm_adapter', f'Expected vllm_adapter, got {engine}'
            stamp = g.stamp_governance('test-svc', 'indestructibleeco', 'Deployment')
            assert stamp['document_metadata']['schema_version'] == 'v1'
            assert 'indestructibleeco://' in stamp['document_metadata']['uri']
            print('Governance engine tests passed')
            PYEOF
            cd backend/ai && python3 /tmp/test_governance.py
      - run:
          name: "Shared utils tests"
          command: |
            cat > /tmp/test_utils.py << 'PYEOF'
            import sys
            sys.path.insert(0, '.')
            from backend.shared.utils import new_uuid, build_uri, build_urn, governance_stamp, build_qyaml_metadata
            uid = new_uuid()
            assert uid.version == 1
            uri = build_uri('k8s', 'deployment', 'test')
            assert uri == 'indestructibleeco://k8s/deployment/test'
            stamp = governance_stamp()
            assert stamp['schema_version'] == 'v1'
            meta = build_qyaml_metadata('api', 'indestructibleeco', 'Deployment', 'gke-production')
            assert 'document_metadata' in meta
            print('Shared utils tests passed')
            PYEOF
            python3 /tmp/test_utils.py
      - run:
          name: "YAML Toolkit tests"
          command: |
            mkdir -p /tmp/toolkit-test
            echo '{"name":"test-svc","image":"ghcr.io/test:v1","replicas":2,"ports":[3000],"depends_on":["redis"]}' > /tmp/toolkit-test/module.json
            node tools/yaml-toolkit/bin/cli.js gen --input=/tmp/toolkit-test/module.json --output=/tmp/toolkit-test
            node tools/yaml-toolkit/bin/cli.js validate /tmp/toolkit-test/test-svc.qyaml
            echo "YAML Toolkit tests passed"
      - run:
          name: "Skill creator tests"
          command: |
            pip install pytest jsonschema -q 2>/dev/null
            python3 -m pytest tools/skill-creator/skills/ -v --tb=short
            echo "Skill creator tests passed"

workflows:
  indestructibleeco-ci:
    jobs:
      - runner-test
      - validate
      - lint:
          requires: [validate]
      - test:
          requires: [lint]
