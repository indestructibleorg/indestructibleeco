name: Governance Replay

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to replay governance decision"
        required: true
        type: number
      dry_run:
        description: "Dry run (no mutations)"
        required: false
        default: "true"
        type: choice
        options:
          - "true"
          - "false"
      snapshot_artifact:
        description: "Artifact name containing replay snapshot (leave empty to capture fresh)"
        required: false
        type: string

  workflow_call:
    inputs:
      pr_number:
        required: true
        type: number
      dry_run:
        required: false
        default: "true"
        type: string
      snapshot_artifact:
        required: false
        default: ""
        type: string
    outputs:
      action:
        description: "Governance action taken"
        value: ${{ jobs.replay.outputs.action }}
      outcome:
        description: "Governance outcome"
        value: ${{ jobs.replay.outputs.outcome }}
      audit_hash:
        description: "SHA-256 hash of audit trail"
        value: ${{ jobs.replay.outputs.audit_hash }}

permissions:
  contents: read
  pull-requests: write
  issues: write
  checks: read

jobs:
  replay:
    name: "Replay PR #${{ inputs.pr_number }}"
    runs-on: ubuntu-latest
    outputs:
      action: ${{ steps.extract.outputs.action }}
      outcome: ${{ steps.extract.outputs.outcome }}
      audit_hash: ${{ steps.extract.outputs.audit_hash }}

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: "3.11"

      - name: Download snapshot artifact (if provided)
        if: inputs.snapshot_artifact != ''
        uses: actions/download-artifact@fa0a91b85d4f404e444306234a3b2c8f8e4e4e4e
        with:
          name: ${{ inputs.snapshot_artifact }}
          path: artifacts/replay/

      - name: Run governance engine
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          DRY_RUN: ${{ inputs.dry_run }}
          ARTIFACTS_DIR: artifacts
        run: |
          DRY_FLAG=""
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            DRY_FLAG="--dry-run"
          fi
          python3 tools/autoecops-governance/engine.py \
            --pr ${{ inputs.pr_number }} \
            $DRY_FLAG

      - name: Extract audit outputs
        id: extract
        run: |
          python3 tools/autoecops-governance/extract_audit_outputs.py \
            "artifacts/audit/pr-${{ inputs.pr_number }}-audit.json"

      - name: Upload governance artifacts
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: governance-pr-${{ inputs.pr_number }}-${{ github.run_id }}
          path: artifacts/
          retention-days: 90

      - name: Summary
        if: always()
        run: |
          echo "## Governance Replay â€” PR #${{ inputs.pr_number }}" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Field | Value |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-------|-------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| PR | #${{ inputs.pr_number }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Dry Run | ${{ inputs.dry_run }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Action | ${{ steps.extract.outputs.action }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Outcome | ${{ steps.extract.outputs.outcome }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Audit Hash | \`${{ steps.extract.outputs.audit_hash }}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "Artifacts: \`governance-pr-${{ inputs.pr_number }}-${{ github.run_id }}\`" >> "$GITHUB_STEP_SUMMARY"
