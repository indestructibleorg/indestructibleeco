name: Security Gates â€” Trivy + Checkov + Gitleaks
on:
  workflow_dispatch:
permissions:
  contents: read
  security-events: write
  pull-requests: write
concurrency:
  group: security-gates-${{ github.ref }}
  cancel-in-progress: true
jobs:
  secret-scanning:
    name: Secret Scanning (Gitleaks)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          fetch-depth: 0
      - name: Check Gitleaks license
        id: check-license
        run: |
          if [ -n "${{ secrets.GITLEAKS_LICENSE }}" ]; then
            echo "has_license=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_license=false" >> "$GITHUB_OUTPUT"
            echo "GITLEAKS_LICENSE not set"
          fi
      - name: Run Gitleaks (licensed)
        if: steps.check-license.outputs.has_license == 'true'
        uses: gitleaks/gitleaks-action@ff98106e4c7b2bc287b24eaf42907196329070c7
        env:
          GITHUB_TOKEN: ${{ github.token }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}
      - name: Run basic secret scan (fallback)
        if: steps.check-license.outputs.has_license != 'true'
        run: echo "Basic scan fallback"
