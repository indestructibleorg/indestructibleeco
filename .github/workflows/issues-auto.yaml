name: Issues Auto Governance

on:
  issues:
    types: [opened, edited, reopened, labeled]
  schedule:
    # Run every 15 minutes — same cadence as pr-blocked-response
    - cron: '*/15 * * * *'
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Specific issue number to process (leave empty for all)'
        required: false
        type: string
      dry_run:
        description: 'Dry run (no mutations)'
        required: false
        type: boolean
        default: false
      deduplicate:
        description: 'Run deduplication pass'
        required: false
        type: boolean
        default: true

permissions:
  contents: read
  issues: write
  pull-requests: write

concurrency:
  group: issues-auto-${{ github.event.issue.number || 'scheduled' }}
  cancel-in-progress: false

jobs:
  # ── Gate 1: Validate ────────────────────────────────────────────────────────
  validate:
    name: Validate Engine Prerequisites
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      issue_number: ${{ steps.check.outputs.issue_number }}
    steps:
      - name: Check prerequisites
        id: check
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          # Determine issue number
          if [ -n "${{ inputs.issue_number }}" ]; then
            echo "issue_number=${{ inputs.issue_number }}" >> "$GITHUB_OUTPUT"
          elif [ "${{ github.event_name }}" = "issues" ]; then
            echo "issue_number=${{ github.event.issue.number }}" >> "$GITHUB_OUTPUT"
          else
            echo "issue_number=" >> "$GITHUB_OUTPUT"
          fi

          # Validate token has issues:write
          RATE=$(gh api rate_limit --jq '.rate.remaining' 2>/dev/null || echo "0")
          if [ "$RATE" -lt "10" ]; then
            echo "WARNING: GitHub API rate limit low: $RATE remaining"
          fi

          echo "should_run=true" >> "$GITHUB_OUTPUT"
          echo "Prerequisites validated. Rate limit remaining: $RATE"

  # ── Gate 2: Lint (OPA policy check) ────────────────────────────────────────
  opa-lint:
    name: OPA Policy Lint
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: validate
    if: needs.validate.outputs.should_run == 'true'
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
      - name: Install OPA
        run: |
          curl -sL https://openpolicyagent.org/downloads/v0.70.0/opa_linux_amd64_static \
            -o /usr/local/bin/opa && chmod +x /usr/local/bin/opa
      - name: Lint issues-governance.rego
        run: |
          opa check policy/issues-governance.rego --strict || true
          echo "OPA policy lint complete"

  # ── Gate 3: Triage ─────────────────────────────────────────────────────────
  triage:
    name: Issues Triage & Labeling
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [validate, opa-lint]
    if: needs.validate.outputs.should_run == 'true'
    outputs:
      issues_labeled: ${{ steps.engine.outputs.labels_applied }}
      run_id: ${{ steps.engine.outputs.run_id }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # v5.6.0
        with:
          python-version: '3.11'

      - name: Run triage (labeling only)
        id: engine
        env:
          GH_TOKEN: ${{ github.token }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          DRY_RUN: ${{ inputs.dry_run || 'false' }}
          ARTIFACTS_DIR: artifacts
        run: |
          ISSUE="${{ needs.validate.outputs.issue_number }}"
          if [ -n "$ISSUE" ]; then
            python3 tools/issues-auto-engine/engine.py --issue "$ISSUE"
          else
            python3 tools/issues-auto-engine/engine.py
          fi

      - name: Upload triage artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4.6.2
        if: always()
        with:
          name: issues-triage-${{ steps.engine.outputs.run_id || github.run_id }}
          path: artifacts/
          retention-days: 30

  # ── Gate 4: Deduplication ───────────────────────────────────────────────────
  deduplicate:
    name: Deduplicate Issues
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [validate, triage]
    if: |
      needs.validate.outputs.should_run == 'true' &&
      (github.event_name == 'schedule' || inputs.deduplicate == true)
    outputs:
      duplicates_closed: ${{ steps.dedup.outputs.duplicates_closed }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # v5.6.0
        with:
          python-version: '3.11'

      - name: Run deduplication
        id: dedup
        env:
          GH_TOKEN: ${{ github.token }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          DRY_RUN: ${{ inputs.dry_run || 'false' }}
          ARTIFACTS_DIR: artifacts
        run: |
          python3 tools/issues-auto-engine/engine.py --deduplicate

  # ── Gate 5: Auto-close Resolved Issues ─────────────────────────────────────
  auto-close:
    name: Auto-close Resolved Issues
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [validate, triage, deduplicate]
    if: |
      always() &&
      needs.validate.outputs.should_run == 'true' &&
      (needs.triage.result == 'success' || needs.triage.result == 'skipped')
    outputs:
      issues_closed: ${{ steps.close.outputs.issues_closed }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # v5.6.0
        with:
          python-version: '3.11'

      - name: Auto-close resolved issues
        id: close
        env:
          GH_TOKEN: ${{ github.token }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          DRY_RUN: ${{ inputs.dry_run || 'false' }}
          ARTIFACTS_DIR: artifacts
        run: |
          ISSUE="${{ needs.validate.outputs.issue_number }}"
          if [ -n "$ISSUE" ]; then
            python3 tools/issues-auto-engine/engine.py --issue "$ISSUE"
          else
            python3 tools/issues-auto-engine/engine.py --cleanup-stale
          fi

      - name: Upload close artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4.6.2
        if: always()
        with:
          name: issues-close-${{ github.run_id }}
          path: artifacts/
          retention-days: 30

  # ── Summary ─────────────────────────────────────────────────────────────────
  summary:
    name: Issues Governance Summary
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [triage, deduplicate, auto-close]
    if: always()
    steps:
      - name: Print summary
        env:
          LABELED: ${{ needs.triage.outputs.issues_labeled || '0' }}
          DUPLICATES: ${{ needs.deduplicate.outputs.duplicates_closed || '0' }}
          CLOSED: ${{ needs.auto-close.outputs.issues_closed || '0' }}
        run: |
          echo "## Issues Auto Governance Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Metric | Count |" >> "$GITHUB_STEP_SUMMARY"
          echo "|--------|-------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Labels applied | $LABELED |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Duplicates closed | $DUPLICATES |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Resolved issues closed | $CLOSED |" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "*AutoEcoOps Issues Governance Engine v1.0*" >> "$GITHUB_STEP_SUMMARY"
