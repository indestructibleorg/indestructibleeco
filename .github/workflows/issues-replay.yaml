name: Issues Decision Replay

# Replayable Issues governance workflow.
# Given a run_id (from a previous issues-auto run), replays the exact same
# decisions against the same issue snapshot — enabling audit verification.
#
# Governance properties satisfied:
#   ✅ Replayable: uses immutable artifact snapshot from original run
#   ✅ Verifiable: SHA-256 hash comparison between original and replay
#   ✅ Auditable: generates replay audit trail with diff

on:
  workflow_dispatch:
    inputs:
      original_run_id:
        description: 'GitHub Actions run ID to replay (from issues-auto workflow)'
        required: true
        type: string
      verify_only:
        description: 'Only verify decisions, do not apply mutations'
        required: false
        type: boolean
        default: true
      issue_number:
        description: 'Specific issue to replay (leave empty for full run)'
        required: false
        type: string

permissions:
  contents: read
  issues: write
  actions: read

concurrency:
  group: issues-replay-${{ inputs.original_run_id }}
  cancel-in-progress: false

jobs:
  # ── Step 1: Download original run artifacts ─────────────────────────────────
  download-snapshot:
    name: Download Original Run Snapshot
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      snapshot_hash: ${{ steps.snapshot.outputs.hash }}
      original_stats: ${{ steps.snapshot.outputs.stats }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # v5.6.0
        with:
          python-version: '3.11'

      - name: Download original run artifacts
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093  # v4.3.0
        with:
          run-id: ${{ inputs.original_run_id }}
          github-token: ${{ github.token }}
          path: original-artifacts/

      - name: Extract snapshot metadata
        id: snapshot
        run: |
          # Find the audit file from the original run
          AUDIT_FILE=$(find original-artifacts/ -name "*-audit.json" | head -1)
          if [ -z "$AUDIT_FILE" ]; then
            echo "ERROR: No audit file found in original run artifacts"
            exit 1
          fi

          echo "Found audit file: $AUDIT_FILE"

          # Extract audit hash and stats using helper script (no inline python -c)
          ORIGINAL_HASH=$(python3 tools/issues-auto-engine/extract_audit.py "$AUDIT_FILE" hash)
          STATS=$(python3 tools/issues-auto-engine/extract_audit.py "$AUDIT_FILE" stats)

          echo "hash=$ORIGINAL_HASH" >> "$GITHUB_OUTPUT"
          echo "stats=$STATS" >> "$GITHUB_OUTPUT"
          echo "Original run audit hash: $ORIGINAL_HASH"
          echo "Original run stats: $STATS"

      - name: Upload snapshot for replay job
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4.6.2
        with:
          name: replay-snapshot-${{ inputs.original_run_id }}
          path: original-artifacts/
          retention-days: 7

  # ── Step 2: Replay decisions ─────────────────────────────────────────────────
  replay-decisions:
    name: Replay Issues Decisions
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: download-snapshot
    outputs:
      replay_hash: ${{ steps.replay.outputs.replay_hash }}
      hash_match: ${{ steps.verify.outputs.hash_match }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # v5.6.0
        with:
          python-version: '3.11'

      - name: Download snapshot
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093  # v4.3.0
        with:
          name: replay-snapshot-${{ inputs.original_run_id }}
          path: original-artifacts/

      - name: Run replay (verify_only mode)
        id: replay
        env:
          GH_TOKEN: ${{ github.token }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          # Always dry-run in verify_only mode
          DRY_RUN: ${{ inputs.verify_only }}
          ARTIFACTS_DIR: replay-artifacts
        run: |
          ISSUE="${{ inputs.issue_number }}"
          if [ -n "$ISSUE" ]; then
            python3 tools/issues-auto-engine/engine.py --issue "$ISSUE"
          else
            python3 tools/issues-auto-engine/engine.py --deduplicate
          fi

          # Extract replay audit hash using helper script (no inline python -c)
          REPLAY_AUDIT=$(find replay-artifacts/ -name "*-audit.json" | head -1)
          if [ -n "$REPLAY_AUDIT" ]; then
            REPLAY_HASH=$(python3 tools/issues-auto-engine/extract_audit.py "$REPLAY_AUDIT" hash)
            echo "replay_hash=$REPLAY_HASH" >> "$GITHUB_OUTPUT"
            echo "Replay audit hash: $REPLAY_HASH"
          fi

      - name: Verify hash consistency
        id: verify
        run: |
          ORIGINAL="${{ needs.download-snapshot.outputs.snapshot_hash }}"
          REPLAY="${{ steps.replay.outputs.replay_hash }}"

          echo "Original hash: $ORIGINAL"
          echo "Replay hash:   $REPLAY"

          # Note: hashes may differ if issue states changed between runs
          # This is expected — we report the diff, not fail
          if [ "$ORIGINAL" = "$REPLAY" ]; then
            echo "hash_match=true" >> "$GITHUB_OUTPUT"
            echo "VERIFIED: Replay decisions match original run exactly"
          else
            echo "hash_match=false" >> "$GITHUB_OUTPUT"
            echo "DIFF: Replay decisions differ from original (issue states may have changed)"
            echo "This is expected if issues were modified between the original run and replay."
          fi

      - name: Upload replay artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4.6.2
        if: always()
        with:
          name: replay-result-${{ inputs.original_run_id }}-${{ github.run_id }}
          path: replay-artifacts/
          retention-days: 30

  # ── Step 3: Replay audit report ──────────────────────────────────────────────
  audit-report:
    name: Generate Replay Audit Report
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [download-snapshot, replay-decisions]
    if: always()
    steps:
      - name: Generate report
        run: |
          ORIGINAL_HASH="${{ needs.download-snapshot.outputs.snapshot_hash }}"
          REPLAY_HASH="${{ needs.replay-decisions.outputs.replay_hash }}"
          HASH_MATCH="${{ needs.replay-decisions.outputs.hash_match }}"
          ORIGINAL_STATS='${{ needs.download-snapshot.outputs.original_stats }}'

          echo "## Issues Decision Replay Report" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Property | Value |" >> "$GITHUB_STEP_SUMMARY"
          echo "|----------|-------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Original Run ID | ${{ inputs.original_run_id }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Replay Run ID | ${{ github.run_id }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Original Audit Hash | \`${ORIGINAL_HASH:0:16}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Replay Audit Hash | \`${REPLAY_HASH:0:16}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Hash Match | $HASH_MATCH |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Verify Only | ${{ inputs.verify_only }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Original Run Stats" >> "$GITHUB_STEP_SUMMARY"
          echo "\`\`\`json" >> "$GITHUB_STEP_SUMMARY"
          echo "$ORIGINAL_STATS" >> "$GITHUB_STEP_SUMMARY"
          echo "\`\`\`" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "*AutoEcoOps Issues Governance Engine v1.0 — Replay Audit*" >> "$GITHUB_STEP_SUMMARY"
