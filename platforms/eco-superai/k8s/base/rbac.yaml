# ============================================================================
# RBAC Configuration for SuperAI Platform
# ============================================================================
# ServiceAccounts are defined in serviceaccount.yaml
# This file contains Roles, ClusterRoles, and their Bindings
# ============================================================================

---
# Role: Application namespace access (read configmaps/secrets, create events)
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: superai-app-role
  namespace: eco-superai
  labels:
    app.kubernetes.io/name: superai-platform
    app.kubernetes.io/component: rbac
    app.kubernetes.io/managed-by: argocd
rules:
  # ConfigMaps and Secrets — read-only for app configuration
  - apiGroups: [""]
    resources: ["configmaps", "secrets"]
    verbs: ["get", "list", "watch"]
  # Pod introspection for health checks and service discovery
  - apiGroups: [""]
    resources: ["pods", "services", "endpoints"]
    verbs: ["get", "list", "watch"]
  # Events — allow app to emit K8s events for audit/observability
  - apiGroups: [""]
    resources: ["events"]
    verbs: ["create", "patch"]
  # Deployments — read-only for readiness checks
  - apiGroups: ["apps"]
    resources: ["deployments"]
    verbs: ["get", "list", "watch"]

---
# Role: Worker namespace access (broader for job orchestration)
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: superai-worker-role
  namespace: eco-superai
  labels:
    app.kubernetes.io/name: superai-platform
    app.kubernetes.io/component: rbac
    app.kubernetes.io/managed-by: argocd
rules:
  # ConfigMaps — read-only
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["get", "list", "watch"]
  # Secrets — read-only for credentials
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "list"]
  # Pod and log access for job monitoring
  - apiGroups: [""]
    resources: ["pods", "pods/log"]
    verbs: ["get", "list", "watch"]
  # Events for worker lifecycle reporting
  - apiGroups: [""]
    resources: ["events"]
    verbs: ["create", "patch"]
  # Jobs — full lifecycle management for task execution
  - apiGroups: ["batch"]
    resources: ["jobs", "cronjobs"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

---
# ClusterRole: Monitoring (metrics scraping across namespaces)
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: superai-monitoring
  labels:
    app.kubernetes.io/name: superai-platform
    app.kubernetes.io/component: monitoring
    app.kubernetes.io/managed-by: argocd
rules:
  # Node and pod metrics for Prometheus
  - apiGroups: [""]
    resources: ["nodes", "nodes/metrics", "nodes/proxy", "pods", "services", "endpoints"]
    verbs: ["get", "list", "watch"]
  # Non-resource URLs for health and metrics endpoints
  - nonResourceURLs: ["/healthz", "/healthz/*", "/metrics", "/metrics/cadvisor"]
    verbs: ["get"]

---
# ClusterRole: Platform admin (operations team)
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: superai-platform-admin
  labels:
    app.kubernetes.io/name: superai-platform
    app.kubernetes.io/component: rbac
    app.kubernetes.io/managed-by: argocd
rules:
  # Core resources
  - apiGroups: [""]
    resources:
      - pods
      - pods/log
      - pods/exec
      - services
      - endpoints
      - persistentvolumeclaims
      - events
      - configmaps
      - secrets
      - serviceaccounts
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  # Workload resources
  - apiGroups: ["apps"]
    resources: ["deployments", "replicasets", "statefulsets", "daemonsets"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  # Batch resources
  - apiGroups: ["batch"]
    resources: ["jobs", "cronjobs"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  # Autoscaling
  - apiGroups: ["autoscaling"]
    resources: ["horizontalpodautoscalers"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  # Networking
  - apiGroups: ["networking.k8s.io"]
    resources: ["ingresses", "networkpolicies"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  # Policy
  - apiGroups: ["policy"]
    resources: ["poddisruptionbudgets"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  # Metrics
  - apiGroups: ["metrics.k8s.io"]
    resources: ["pods", "nodes"]
    verbs: ["get", "list"]

---
# RoleBinding: Application service account -> app role
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: superai-app-rolebinding
  namespace: eco-superai
  labels:
    app.kubernetes.io/name: superai-platform
    app.kubernetes.io/component: rbac
    app.kubernetes.io/managed-by: argocd
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: superai-app-role
subjects:
  - kind: ServiceAccount
    name: superai-app
    namespace: eco-superai

---
# RoleBinding: Worker service account -> worker role
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: superai-worker-rolebinding
  namespace: eco-superai
  labels:
    app.kubernetes.io/name: superai-platform
    app.kubernetes.io/component: rbac
    app.kubernetes.io/managed-by: argocd
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: superai-worker-role
subjects:
  - kind: ServiceAccount
    name: superai-worker
    namespace: eco-superai

---
# ClusterRoleBinding: Monitoring service account -> monitoring cluster role
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: superai-monitoring-binding
  labels:
    app.kubernetes.io/name: superai-platform
    app.kubernetes.io/component: monitoring
    app.kubernetes.io/managed-by: argocd
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: superai-monitoring
subjects:
  - kind: ServiceAccount
    name: superai-app
    namespace: eco-superai

---
# ClusterRoleBinding: Platform admin group -> admin cluster role
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: superai-platform-admin-binding
  labels:
    app.kubernetes.io/name: superai-platform
    app.kubernetes.io/component: rbac
    app.kubernetes.io/managed-by: argocd
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: superai-platform-admin
subjects:
  - kind: Group
    name: superai-platform-admins
    apiGroup: rbac.authorization.k8s.io
