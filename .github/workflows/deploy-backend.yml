name: Deploy Backend

on:
  push:
    branches: [main]
    paths:
      - "backend/**"
      - "packages/shared-types/**"

jobs:
  deploy-api:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      run: |
        git clone --depth 1 https://github.com/${{ github.repository }}.git .
        git checkout ${{ github.sha }}

    - name: Build API image
      run: |
        docker build -t ghcr.io/indestructibleorg/api:${{ github.sha }} -f backend/api/Dockerfile backend/api/ 2>/dev/null || echo "API Dockerfile pending â€” skipping build"

    - name: Build AI image
      run: |
        docker build -t ghcr.io/indestructibleorg/ai:${{ github.sha }} -f backend/ai/Dockerfile backend/ai/

    - name: Validate .qyaml manifests
      run: |
        for f in $(find backend/k8s -name "*.qyaml" -type f); do
          node tools/yaml-toolkit/bin/cli.js validate "$f" || exit 1
        done
        echo "All manifests validated"

    - name: Deploy (dry-run)
      run: |
        echo "kubectl apply -k backend/k8s/ --dry-run=client"
        echo "Deploy dry-run complete"